# https://moonrepo.dev/docs/config/tasks
$schema: "https://moonrepo.dev/schemas/tasks.json"

# Shared task definitions inherited by all projects
# Projects can override these in their own moon.yml
# Use tokens like @in(0) for entry point customization in projects

# Global task options - run commands from project directory, not workspace root
taskOptions:
  runFromWorkspaceRoot: false

# Define reusable file groups
fileGroups:
  sources:
    - "src/**/*.ts"
    - "src/**/*.tsx"
  configs:
    - "tsconfig.json"
    - "eslint.config.{mjs,js}"
    - ".prettierrc*"
  tests:
    - "src/**/*.test.ts"
    - "src/**/*.test.tsx"
    - "tests/**/*.ts"

# Implicit inputs that apply to most tasks
implicitInputs:
  - "package.json"
  - "tsconfig.json"

tasks:
  # ============================================
  # Code Quality Tasks
  # ============================================
  
  # Type checking
  check-types:
    command: "tsgo --noEmit"
    inputs:
      - "@group(sources)"
      - "@group(configs)"
    options:
      runInCI: true
      cache: true
      mergeDeps: "append"
      mergeEnv: "append"

  # Linting with ESLint
  lint:
    command: "eslint . --fix"
    inputs:
      - "@group(sources)"
      - "eslint.config.{mjs,js}"
    options:
      runInCI: true
      cache: false
      mergeDeps: "append"
      mergeEnv: "append"

  # Code formatting with Prettier
  prettify:
    command: "prettier --write ./src/"
    inputs:
      - "@group(sources)"
      - ".prettierrc*"
    options:
      runInCI: false
      cache: false

  # ============================================
  # Testing Tasks
  # ============================================
  
  # Run tests with Vitest
  test:
    command: "vitest run"
    inputs:
      - "@group(sources)"
      - "@group(tests)"
      - "vitest.config.{ts,js,mjs}"
    options:
      runInCI: true
      cache: false
      mergeDeps: "append"

  # Run tests in watch mode
  test-watch:
    command: "vitest"
    local: true
    inputs:
      - "@group(sources)"
      - "@group(tests)"
      - "vitest.config.{ts,js,mjs}"
    options:
      persistent: true
      cache: false
      runInCI: false

  # ============================================
  # Build Tasks
  # ============================================
  
  # Standard TypeScript build
  # Libraries without outDir should override with outputs: []
  build:
    command: "tsgo"
    deps:
      - "~:check-types"
    inputs:
      - "@group(sources)"
      - "tsconfig.json"
    outputs:
      - "dist/**/*"
    options:
      cache: true
      runInCI: true
      mergeDeps: "append"
      mergeOutputs: "replace"

  # Clean build output
  clean:
    command: "rimraf dist"
    options:
      cache: false
      runInCI: false

  # ============================================
  # Development Tasks
  # ============================================
  
  # Development server (Node.js with tsx watch)
  # Projects should override this to specify entry point
  dev:
    command: "tsx watch src/index.ts"
    local: true
    options:
      persistent: true
      cache: false
      envFile: ".env"
      outputStyle: "stream"
      mergeEnv: "append"

  # Production start
  start:
    command: "node --import tsx src/index.ts"
    deps:
      - "~:build"
    options:
      cache: false
      envFile: ".env"
      mergeEnv: "append"

# Task groups for easier execution
# implicitDeps:
#   - "^:build"
# Note: Implicit deps disabled - it caused dev tasks to run builds first.
# Add explicit deps in project moon.yml files where needed.

name: Pull Request | CI

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  CI: true

jobs:
  ci:
    name: Validate & Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for moon to detect changes

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.11.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24.11.1
          cache: 'pnpm'

      # Cache moon's task outputs
      - name: Restore moon cache
        uses: actions/cache@v4
        with:
          path: .moon/cache
          key: moon-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            moon-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # moon ci automatically:
      # 1. Detects which projects changed based on git diff
      # 2. Runs only affected tasks in correct dependency order
      # 3. Parallelizes independent tasks
      # 4. Restores cached outputs for unchanged projects
      - name: Run CI tasks
        run: pnpm exec moon ci
        env:
          VITE_SERVER_URL: http://localhost:3000

      # Alternative: Run specific tasks for all projects (if you want full validation)
      # - name: Type check all
      #   run: pnpm exec moon run :check-types
      # - name: Lint all  
      #   run: pnpm exec moon run :lint
      # - name: Build all
      #   run: pnpm exec moon run :build

  # Optional: Run tests in a separate job with MongoDB
  # test-server:
  #   name: Server Tests
  #   runs-on: ubuntu-latest
  #   needs: ci
  #   
  #   services:
  #     mongodb:
  #       image: mongo:8.0
  #       ports:
  #         - 27017:27017
  #   
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #     
  #     - uses: pnpm/action-setup@v4
  #       with:
  #         version: 10.11.0
  #     
  #     - uses: actions/setup-node@v4
  #       with:
  #         node-version: 24.11.1
  #         cache: 'pnpm'
  #     
  #     - name: Restore moon cache
  #       uses: actions/cache@v4
  #       with:
  #         path: .moon/cache
  #         key: moon-${{ runner.os }}-${{ github.sha }}
  #         restore-keys: |
  #           moon-${{ runner.os }}-
  #     
  #     - run: pnpm install --frozen-lockfile
  #     
  #     - name: Run server tests (affected only)
  #       run: pnpm exec moon run server:test --affected
  #       env:
  #         MONGODB_URI: mongodb://localhost:27017/test
